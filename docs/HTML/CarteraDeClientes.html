<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard Óptica</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body class="bg-gradient-to-br from-indigo-100 via-white to-indigo-200 min-h-screen">

  <div class="flex flex-col md:flex-row min-h-screen">
    <!-- Sidebar para escritorio y móvil -->
<aside id="sidebar"
  class="bg-gradient-to-b from-[#4fd3e6] to-[#22325a] text-white w-64 flex-shrink-0 flex-col shadow-lg sticky top-0 h-screen z-30 transition-transform duration-300 hidden md:flex">
  <div class="p-6 flex flex-col items-center">
    <div class="bg-white rounded-full p-0 mb-4 shadow-lg w-28 h-28 flex items-center justify-center border-4 border-indigo-200">
      <img src="/Imagenes/redowan-dhrubo-OWfBsDDOUlQ-unsplash.webp" alt="Logo Óptica" class="h-24 w-24 object-cover rounded-full">
    </div>
    <h2 class="text-3xl font-extrabold mb-8 tracking-wide text-center" style="color:#22325a;">
  Centro Óptico González
</h2>
    <nav class="space-y-2 w-full">
      <a href="Index.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📊</span> <span>Dashboard</span>
      </a>
      <a href="/HTML/Citas.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📅</span> <span>Citas</span>
      </a>
      <a href="/HTML/CarteraDeClientes.html" class="flex items-center gap-3 py-2 px-4 rounded-lg bg-indigo-800 hover:bg-indigo-600 transition font-semibold shadow hover:scale-105">
        <span class="text-xl">👤</span> <span>Clientes</span>
      </a>
      <a href="/HTML/Reportes.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📈</span> <span>Reportes</span>
      </a>
      <a href="/HTML/Configuracion.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">⚙️</span> <span>Configuración</span>
      </a>
    </nav>
  </div>
  <div class="mt-auto p-4 text-xs text-indigo-200 text-center">
    &copy; 2025 Centro Óptico González
  </div>
</aside>

<!-- Sidebar móvil (oculto en escritorio) -->
<div id="sidebarMobileBackdrop" class="fixed inset-0 bg-black bg-opacity-40 z-40 hidden"></div>
<aside id="sidebarMobile"
  class="fixed top-0 left-0 h-full w-64 bg-gradient-to-b from-indigo-900 to-indigo-700 text-white shadow-lg z-50 transform -translate-x-full transition-transform duration-300 flex flex-col md:hidden">
  <div class="p-6 flex flex-col items-center">
    <button id="closeSidebarMobile" class="absolute top-4 right-4 text-white text-2xl focus:outline-none">&times;</button>
    <div class="bg-white rounded-full p-0 mb-4 shadow-lg w-28 h-28 flex items-center justify-center border-4 border-indigo-200">
      <img src="/Imagenes/redowan-dhrubo-OWfBsDDOUlQ-unsplash.webp" alt="Logo Óptica" class="h-24 w-24 object-cover rounded-full">
    </div>
    <h2 class="text-2xl font-bold mb-8 tracking-wide text-center">Centro Óptico González</h2>
    <nav class="space-y-2 w-full">
      <a href="Index.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📊</span> <span>Dashboard</span>
      </a>
      <a href="/HTML/Citas.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📅</span> <span>Citas</span>
      </a>
      <a href="/HTML/CarteraDeClientes.html" class="flex items-center gap-3 py-2 px-4 rounded-lg bg-indigo-800 hover:bg-indigo-600 transition font-semibold shadow hover:scale-105">
        <span class="text-xl">👤</span> <span>Clientes</span>
      </a>
      <a href="/HTML/Reportes.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">📈</span> <span>Reportes</span>
      </a>
      <a href="/HTML/Configuracion.html" class="flex items-center gap-3 py-2 px-4 rounded-lg hover:bg-indigo-600 transition font-semibold hover:scale-105">
        <span class="text-xl">⚙️</span> <span>Configuración</span>
      </a>
    </nav>
  </div>
  <div class="mt-auto p-4 text-xs text-indigo-200 text-center">
    &copy; 2025 Centro Óptico González
  </div>
</aside>

<!-- Botón toggle para móviles -->
<div class="md:hidden fixed top-4 left-4 z-50">
  <button id="sidebarToggle" class="bg-indigo-800 text-white p-2 rounded-full shadow-lg focus:outline-none focus:ring-2 focus:ring-white transition-opacity duration-300">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
    </svg>
  </button>
</div>

    <!-- Contenido principal -->
    <div class="flex-1 flex flex-col">
      <header class="bg-white/80 shadow p-4 flex flex-col sm:flex-row gap-4 sm:gap-0 justify-between items-center sticky top-0 z-10 backdrop-blur">
  <div class="flex items-center">
    <h1 class="text-2xl font-bold text-indigo-800 tracking-wide text-center">Cartera de Clientes</h1>
  </div>
  
  <!-- Agregar un div para botones u otras acciones en el header -->
  <div class="flex gap-3 w-full sm:w-auto flex-col sm:flex-row items-center">
    <!-- Mejorar el campo de búsqueda con icono y mejor espacio -->
<div class="flex items-center relative w-full sm:w-64 md:w-80">
  <span class="absolute left-3 text-gray-400">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
      <path d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z"/>
    </svg>
  </span>
  <input type="text" id="searchInput" placeholder="Buscar cliente..." 
    class="pl-10 pr-9 py-2 w-full rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-300">
  <button id="clearSearchBtn" class="absolute right-2 text-gray-400 hover:text-gray-600">✕</button>
  <!-- Añadir este div para las sugerencias -->
  <div id="searchSuggestions" class="absolute z-50 top-full left-0 mt-1 w-full bg-white rounded-lg shadow-lg border border-gray-200 max-h-60 overflow-y-auto hidden">
    <!-- Las sugerencias se mostrarán aquí -->
  </div>
</div>
    <button id="addClientBtn"
      class="w-full sm:w-auto bg-gradient-to-r from-indigo-600 to-indigo-400 text-white px-6 py-2 rounded-lg shadow hover:from-indigo-700 hover:to-indigo-500 transition focus:outline-none focus:ring-2 focus:ring-indigo-400 font-semibold text-base sm:text-lg">
      + Nuevo Cliente
    </button>
  </div>
</header>

    <!-- Clientes -->
    <main class="flex-1 p-6">
      <section class="bg-white/90 rounded-xl shadow-lg p-6 my-8">
        <div class="mb-6 flex justify-between items-center">
          <div class="flex items-center gap-3">
            <h2 class="text-xl font-bold text-indigo-800">Listado de Clientes</h2>
            <div class="w-2 h-2 rounded-full bg-indigo-400"></div>
            <div id="totalClientesContainer" class="flex items-center gap-2 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 text-indigo-700">
              <svg class="h-5 w-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
                <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
              </svg>
              <span class="font-medium">Total:</span>
              <span id="totalClientes" class="font-bold text-lg">0</span>
              <span class="text-sm">clientes</span>
            </div>
          </div>
          <div class="flex items-center">
            <!-- Aquí puedes agregar controles adicionales como un selector de vista, etc. -->
          </div>
        </div>
        <div id="clientesCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 min-h-[200px]"></div>
        <div id="clientesPagination" class="flex justify-center mt-6 gap-2"></div>
      </section>
    </main>
  </div>
</div>

<!-- Scripts -->
<script>
  const scriptURL = 'https://script.google.com/macros/s/AKfycbzVKb2mrFu-Zzk_Fh3KQQddVJqg9a_hdSptblz2VbBCimM2wk8LjKf093NvI4XMyi0g/exec';
  const deleteURL = 'https://script.google.com/macros/s/AKfycbw0BYHI1iA2tJX5GrVsjSrO8hcfQJWAI7yyEriyVm89JUq79OjoETKWuAHnrHDMoU6m/exec';
  const PAGE_SIZE = 9;
  let clientes = [];
  let paginaActual = 1;

  const sidebarToggle = document.getElementById('sidebarToggle');
  const sidebar = document.getElementById('sidebar');
  sidebarToggle.addEventListener('click', () => sidebar.classList.toggle('hidden'));

  // Mejora de la función para actualizar el total de clientes con animación
function actualizarTotalClientes() {
  const totalElement = document.getElementById('totalClientes');
  if (!totalElement) return;
  
  // Obtener el valor actual y el nuevo valor
  const valorActual = parseInt(totalElement.textContent || '0');
  const nuevoValor = clientes.length;
  
  // Si el valor es el mismo, no hacer nada
  if (valorActual === nuevoValor) return;
  
  // Establecer el estilo para la animación
  totalElement.style.transition = 'all 0.5s ease';
  
  // Si el nuevo valor es mayor, usar color verde
  if (nuevoValor > valorActual) {
    totalElement.textContent = nuevoValor;
    totalElement.classList.add('text-green-600', 'font-bold');
    setTimeout(() => {
      totalElement.classList.remove('text-green-600', 'font-bold');
    }, 1500);
  } 
  // Si es menor, usar color rojo
  else if (nuevoValor < valorActual) {
    totalElement.textContent = nuevoValor;
    totalElement.classList.add('text-red-600', 'font-bold');
    setTimeout(() => {
      totalElement.classList.remove('text-red-600', 'font-bold');
    }, 1500);
  } 
  // Si es igual, simplemente actualizar
  else {
    totalElement.textContent = nuevoValor;
  }
  
  // Mejorar visualmente el contador total
  const contenedorTotal = totalElement.parentElement;
  if (contenedorTotal) {
    contenedorTotal.className = 'flex items-center gap-2 bg-indigo-50 px-3 py-1.5 rounded-lg border border-indigo-100 text-indigo-700';
    contenedorTotal.innerHTML = `
      <svg class="h-5 w-5 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
        <path d="M10 12a2 2 0 100-4 2 2 0 000 4z"></path>
        <path fill-rule="evenodd" d="M.458 10C1.732 5.943 5.522 3 10 3s8.268 2.943 9.542 7c-1.274 4.057-5.064 7-9.542 7S1.732 14.057.458 10zM14 10a4 4 0 11-8 0 4 4 0 018 0z" clip-rule="evenodd"></path>
      </svg>
      <span class="font-medium">Total:</span>
      <span id="totalClientes" class="font-bold text-lg">${nuevoValor}</span>
      <span class="text-sm">clientes</span>
    `;
  }
}

  async function cargarClientes() {
    // Muestra loader
    document.getElementById('clientesCards').innerHTML = `
      <div id="clientesLoader" class="col-span-4 flex justify-center items-center py-12">
        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-indigo-500"></div>
        <span class="ml-4 text-indigo-700 font-semibold">Cargando clientes...</span>
      </div>
    `;
    
    try {
      const res = await fetch(scriptURL);
      const data = await res.json();
      
      // Filtrar clientes sin número de teléfono y eliminar duplicados
      const telefonosUnicos = new Map();
      let clientesSinTelefono = 0;
      let clientesDuplicados = 0;
      
      // Procesar los clientes
      data.forEach(cliente => {
        const telefono = String(cliente['Numero'] || '').trim();
        
        // Si no tiene teléfono, ignorar el cliente
        if (!telefono) {
          clientesSinTelefono++;
          return;
        }
        
        // Si ya existe un cliente con este teléfono
        if (telefonosUnicos.has(telefono)) {
          clientesDuplicados++;
          const clienteExistente = telefonosUnicos.get(telefono);
          
          // Si el cliente actual tiene una fecha más reciente, reemplazar
          if (cliente['Fecha'] && (!clienteExistente['Fecha'] || 
              new Date(cliente['Fecha']) > new Date(clienteExistente['Fecha']))) {
            telefonosUnicos.set(telefono, cliente);
          }
        } else {
          // Si no existe cliente con este teléfono, agregarlo
          telefonosUnicos.set(telefono, cliente);
        }
      });
      
      // Convertir el Map a un array
      clientes = Array.from(telefonosUnicos.values());
      
      // Actualizar contador y mostrar clientes
      actualizarTotalClientes();
      mostrarPagina(1);
      
      // Mostrar notificaciones
      if (clientesSinTelefono > 0) {
        mostrarNotificacion(`Se ignoraron ${clientesSinTelefono} clientes sin número de teléfono.`, 'warning');
      }
      
      if (clientesDuplicados > 0) {
        mostrarNotificacion(`Se combinaron ${clientesDuplicados} registros duplicados por teléfono.`, 'info');
      }
    } catch (error) {
      console.error("Error al cargar clientes:", error);
      document.getElementById('clientesCards').innerHTML = `
        <div class="col-span-1 sm:col-span-2 lg:col-span-3 p-8 text-center">
          <div class="bg-red-50 border-l-4 border-red-500 p-6 rounded-lg">
            <p class="text-red-700 font-semibold">Error al cargar los clientes</p>
            <p class="text-gray-500 mt-2">Por favor, intenta nuevamente más tarde</p>
          </div>
        </div>
      `;
    }
  }

  // Reemplazar la función mostrarPagina


function mostrarPagina(pagina) {
  paginaActual = pagina;
  const container = document.getElementById('clientesCards');
  container.innerHTML = '';
  const inicio = (pagina - 1) * PAGE_SIZE;
  const fin = inicio + PAGE_SIZE;
  const paginaClientes = clientes.slice(inicio, fin);

  paginaClientes.forEach((c, idx) => {
    // Obtener iniciales para el avatar
    const iniciales = ((c['Nombre Cliente'] || '').match(/\b\w/g) || []).join('').toUpperCase().substring(0, 2);
    
    // Determinar color de estado
    const estadoClase = c['Estado'] && c['Estado'].toLowerCase() === 'activo' 
      ? 'bg-green-100 text-green-800 border-green-200' 
      : 'bg-gray-100 text-gray-700 border-gray-200';
    
    const card = document.createElement('div');
    card.className = "rounded-xl shadow border border-indigo-100 p-5 flex flex-col gap-3 bg-white hover:shadow-2xl hover:-translate-y-1 transition duration-300";
    card.innerHTML = `
      <div class="flex items-center justify-between">
        <div class="flex items-center">
          <div class="cliente-avatar">${iniciales}</div>
          <div>
            <h3 class="font-bold text-indigo-900 text-lg leading-tight">${c['Nombre Cliente'] || 'Sin nombre'}</h3>
            <span class="text-xs font-medium px-2 py-0.5 rounded-full ${estadoClase}">${c['Estado'] || 'Sin estado'}</span>
          </div>
        </div>
        <div class="relative">
          <button class="settings-btn text-gray-400 hover:text-indigo-600 p-1 rounded-full hover:bg-indigo-50 transition" data-id="${c['ID'] || idx}">
            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
              <path d="M10 6a2 2 0 110-4 2 2 0 010 4zM10 12a2 2 0 110-4 2 2 0 010 4zM10 18a2 2 0 110-4 2 2 0 010 4z"></path>
            </svg>
          </button>
          <div class="settings-menu hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-xl z-50" id="settings-menu-${c['ID'] || idx}">
            <div class="py-1">
              <button class="delete-client-btn flex w-full items-center px-4 py-2 text-sm text-red-600 hover:bg-red-50" data-id="${c['ID']}" data-index="${inicio + idx}">
                <svg class="mr-2 h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Eliminar cliente
              </button>
            </div>
          </div>
        </div>
      </div>
      
      <div class="grid grid-cols-2 gap-3 mt-1">
        <div>
          <div class="info-label">Teléfono</div>
          <div class="flex items-center gap-1 text-gray-700">
            <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
              <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
            </svg>
            ${c['Numero'] || 'No disponible'}
          </div>
        </div>
        <div>
          <div class="info-label">Servicio</div>
          <div class="flex items-center gap-1 text-gray-700">
            <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
            </svg>
            ${c['Servicio'] || 'No especificado'}
          </div>
        </div>
      </div>
      
      <button onclick="mostrarMasInfo(${inicio + idx})" class="mt-2 btn-ver-mas bg-indigo-500 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-600 transition self-end flex items-center gap-1">
        <span>Ver detalles</span>
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
        </svg>
      </button>
      <div id="infoExtra${inicio + idx}" class="hidden mt-3 text-sm text-gray-700"></div>
    `;
    container.appendChild(card);
  });
  
  // Configurar botones de opciones de cliente
  setupSettingsButtons();
  
  renderizarPaginacion();
}

// Función para configurar los botones de opciones
function setupSettingsButtons() {
  // Cerrar todos los menús cuando se hace clic en cualquier otro lugar
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.settings-btn') && !e.target.closest('.settings-menu')) {
      document.querySelectorAll('.settings-menu').forEach(menu => {
        menu.classList.add('hidden');
      });
    }
  });

  // Configurar eventos para botones de opciones
  document.querySelectorAll('.settings-btn').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.stopPropagation();
      const id = this.getAttribute('data-id');
      const menu = document.getElementById(`settings-menu-${id}`);
      
      // Cerrar todos los otros menús
      document.querySelectorAll('.settings-menu').forEach(m => {
        if (m !== menu) m.classList.add('hidden');
      });
      
      // Mostrar u ocultar este menú
      menu.classList.toggle('hidden');
    });
  });

  // Configurar eventos para botones de eliminar
  document.querySelectorAll('.delete-client-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      const id = this.getAttribute('data-id');
      const index = parseInt(this.getAttribute('data-index'));
      
      mostrarConfirmacionEliminar(id, index);
    });
  });
}

// Función para mostrar confirmación de eliminación
function mostrarConfirmacionEliminar(id, index) {
  const cliente = clientes[index];
  
  // Crear modal de confirmación
  const modal = document.createElement('div');
  modal.className = 'fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50';
  modal.innerHTML = `
    <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4 transform transition-all animate-fadeIn">
      <h3 class="text-lg font-bold text-gray-900 mb-2">Confirmar eliminación</h3>
      <p class="text-gray-600 mb-1">¿Está seguro que desea eliminar al cliente?</p>
      <div class="bg-gray-50 p-3 rounded my-3">
        <p class="font-medium">${cliente['Nombre Cliente'] || 'Sin nombre'}</p>
        <p class="text-sm text-gray-500">${cliente['Numero'] || ''}</p>
      </div>
      <p class="text-red-500 text-sm mb-4">Esta acción no puede deshacerse.</p>
      <div class="flex justify-end gap-2 mt-4">
        <button id="cancelDelete" class="px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded transition">
          Cancelar
        </button>
        <button id="confirmDelete" data-id="${id}" data-index="${index}" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded transition">
          Eliminar
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Configurar eventos
  document.getElementById('cancelDelete').addEventListener('click', () => {
    document.body.removeChild(modal);
  });
  
  document.getElementById('confirmDelete').addEventListener('click', () => {
    eliminarCliente(id, index);
    document.body.removeChild(modal);
  });
}

// Reemplazar la función eliminarCliente existente

// Modificar la función eliminarCliente para usar JSONP en lugar de fetch directo

async function eliminarCliente(id, index) {
  try {
    // Mostrar notificación de proceso
    mostrarNotificacion('Procesando eliminación...', 'info');
    
    // Crear un iframe temporal para manejar la solicitud sin problemas CORS
    const iframe = document.createElement('iframe');
    iframe.style.display = 'none';
    document.body.appendChild(iframe);
    
    // Crear una promesa para manejar el resultado
    const deletePromise = new Promise((resolve, reject) => {
      // Establecer un tiempo límite para la operación (15 segundos)
      const timeoutId = setTimeout(() => {
        reject(new Error("La operación de eliminación ha excedido el tiempo límite."));
        document.body.removeChild(iframe);
      }, 15000);
      
      // Definir función de callback global que será llamada por el script
      window.deleteCallback = function(result) {
        clearTimeout(timeoutId);
        if (iframe.parentNode) document.body.removeChild(iframe);
        resolve(result);
        delete window.deleteCallback;
      };
      
      // Cargar la URL del script en el iframe con el ID a eliminar y el nombre de la función callback
      iframe.src = `${deleteURL}?id=${id}&callback=deleteCallback`;
    });
    
    // Esperar la respuesta
    const result = await deletePromise;
    
    if (result && result.success) {
      // Eliminar cliente del array local
      clientes.splice(index, 1);
      
      // Actualizar la vista
      actualizarTotalClientes();
      
      // Si la página actual quedó vacía y no es la primera página, ir a la anterior
      const totalPaginas = Math.ceil(clientes.length / PAGE_SIZE);
      if (paginaActual > totalPaginas && paginaActual > 1) {
        paginaActual--;
      }
      
      mostrarPagina(paginaActual);
      
      // Mostrar notificación de éxito
      mostrarNotificacion('Cliente eliminado correctamente', 'success');
    } else {
      mostrarNotificacion(`Error al eliminar cliente: ${result?.error || 'Error desconocido'}`, 'error');
    }
  } catch (error) {
    console.error('Error:', error);
    
    // Mensaje más específico según el tipo de error
    let errorMsg = 'Error al eliminar cliente. ';
    
    if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
      errorMsg += 'No se pudo conectar con el servidor. Verifica tu conexión.';
    } else if (error.name === 'AbortError') {
      errorMsg += 'La operación tardó demasiado tiempo y se canceló.';
    } else {
      errorMsg += error.message || 'Por favor, intente de nuevo más tarde.';
    }
    
    mostrarNotificacion(errorMsg, 'error');
  }
}


// Función para mostrar notificaciones
function mostrarNotificacion(mensaje, tipo = 'info') {
  // Crear el elemento de notificación
  const notificacion = document.createElement('div');
  
  // Definir clases según el tipo de notificación
  let clases, icon;
  
  switch (tipo) {
    case 'error':
      clases = 'bg-red-50 border-red-500 text-red-700';
      icon = '<svg class="h-5 w-5 text-red-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path></svg>';
      break;
    case 'success':
      clases = 'bg-green-50 border-green-500 text-green-700';
      icon = '<svg class="h-5 w-5 text-green-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>';
      break;
    case 'warning':
      clases = 'bg-yellow-50 border-yellow-500 text-yellow-700';
      icon = '<svg class="h-5 w-5 text-yellow-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
      break;
    default:
      clases = 'bg-blue-50 border-blue-500 text-blue-700';
      icon = '<svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2h-1V9a1 1 0 00-1-1z" clip-rule="evenodd"></path></svg>';
  }
    
  notificacion.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg border-l-4 ${clases} transform transition-transform duration-500 ease-in-out z-50`;
  
  notificacion.innerHTML = `
    <div class="flex items-center">
      <div class="flex-shrink-0">
        ${icon}
      </div>
      <div class="ml-3">
        <p class="text-sm font-medium">${mensaje}</p>
      </div>
      <div class="ml-auto pl-3">
        <button class="inline-flex text-gray-400 hover:text-gray-500">
          <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
          </svg>
        </button>
      </div>
    </div>
  `;
  
  // Agregar al DOM
  document.body.appendChild(notificacion);
  
  // Agregar evento para cerrar la notificación
  notificacion.querySelector('button').addEventListener('click', () => {
    notificacion.classList.add('opacity-0', 'translate-x-full');
    setTimeout(() => notificacion.remove(), 500);
  });
  
  // Auto-eliminar después de 5 segundos
  setTimeout(() => {
    if (document.body.contains(notificacion)) {
      notificacion.classList.add('opacity-0', 'translate-x-full');
      setTimeout(() => notificacion.remove(), 500);
    }
  }, 5000);
}

  // Mejora de la función renderizarPaginacion para una paginación más avanzada
function renderizarPaginacion() {
  const paginacion = document.getElementById('clientesPagination');
  paginacion.innerHTML = '';
  const totalPaginas = Math.ceil(clientes.length / PAGE_SIZE);
  
  if (totalPaginas <= 1) return; // No mostrar paginación si solo hay una página
  
  // Contenedor con mejor estilo
  paginacion.className = 'flex justify-center items-center mt-8 gap-1';
  
  // Botón "Anterior"
  const btnAnterior = document.createElement('button');
  btnAnterior.innerHTML = `
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
    </svg>
  `;
  btnAnterior.className = `rounded-lg w-10 h-10 flex items-center justify-center ${
    paginaActual === 1 
      ? 'text-gray-400 cursor-not-allowed bg-gray-100' 
      : 'text-indigo-700 hover:bg-indigo-100 bg-white border border-indigo-200 hover:shadow-md transition'
  }`;
  
  if (paginaActual > 1) {
    btnAnterior.onclick = () => mostrarPagina(paginaActual - 1);
  }
  paginacion.appendChild(btnAnterior);
  
  // Determinar qué páginas mostrar
  const MAX_VISIBLE = 5;
  let startPage = Math.max(1, paginaActual - Math.floor(MAX_VISIBLE / 2));
  let endPage = Math.min(totalPaginas, startPage + MAX_VISIBLE - 1);
  
  // Ajustar si estamos cerca del final
  if (endPage - startPage + 1 < MAX_VISIBLE && startPage > 1) {
    startPage = Math.max(1, endPage - MAX_VISIBLE + 1);
  }
  
  // Primera página
  if (startPage > 1) {
    const btn = document.createElement('button');
    btn.textContent = '1';
    btn.className = `rounded-lg w-10 h-10 flex items-center justify-center font-medium ${
      1 === paginaActual 
        ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
        : 'text-indigo-700 hover:bg-indigo-100 bg-white border border-indigo-200 hover:shadow-md transition'
    }`;
    btn.onclick = () => mostrarPagina(1);
    paginacion.appendChild(btn);
    
    // Puntos suspensivos si hay salto
    if (startPage > 2) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'text-gray-500 px-2';
      paginacion.appendChild(dots);
    }
  }
  
  // Páginas numeradas
  for (let i = startPage; i <= endPage; i++) {
    if (i === 1 || i === totalPaginas) continue; // Ya manejamos primera y última página aparte
    
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = `rounded-lg w-10 h-10 flex items-center justify-center font-medium ${
      i === paginaActual 
        ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
        : 'text-indigo-700 hover:bg-indigo-100 bg-white border border-indigo-200 hover:shadow-md transition'
    }`;
    btn.onclick = () => mostrarPagina(i);
    paginacion.appendChild(btn);
  }
  
  // Última página
  if (endPage < totalPaginas) {
    // Puntos suspensivos si hay salto
    if (endPage < totalPaginas - 1) {
      const dots = document.createElement('span');
      dots.textContent = '...';
      dots.className = 'text-gray-500 px-2';
      paginacion.appendChild(dots);
    }
    
    const btn = document.createElement('button');
    btn.textContent = totalPaginas;
    btn.className = `rounded-lg w-10 h-10 flex items-center justify-center font-medium ${
      totalPaginas === paginaActual 
        ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-200' 
        : 'text-indigo-700 hover:bg-indigo-100 bg-white border border-indigo-200 hover:shadow-md transition'
    }`;
    btn.onclick = () => mostrarPagina(totalPaginas);
    paginacion.appendChild(btn);
  }
  
  // Botón "Siguiente"
  const btnSiguiente = document.createElement('button');
  btnSiguiente.innerHTML = `
    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
    </svg>
  `;
  btnSiguiente.className = `rounded-lg w-10 h-10 flex items-center justify-center ${
    paginaActual === totalPaginas 
      ? 'text-gray-400 cursor-not-allowed bg-gray-100' 
      : 'text-indigo-700 hover:bg-indigo-100 bg-white border border-indigo-200 hover:shadow-md transition'
  }`;
  
  if (paginaActual < totalPaginas) {
    btnSiguiente.onclick = () => mostrarPagina(paginaActual + 1);
  }
  paginacion.appendChild(btnSiguiente);
}


// Reemplazar la función mostrarMasInfo

window.mostrarMasInfo = function(idx) {
  const infoDiv = document.getElementById('infoExtra' + idx);
  const btnTexto = infoDiv.previousElementSibling;
  
  if (infoDiv.classList.contains('hidden')) {
    const c = clientes[idx];

    // Formatea fecha y hora si existe
    let fecha = 'No registrada';
    let hora = 'No registrada';
    if (c['Fecha']) {
      const fechaObj = new Date(c['Fecha']);
      fecha = fechaObj.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
      hora = fechaObj.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });
    }

    infoDiv.innerHTML = `
      <div class="info-extra-container p-4 mt-2">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="bg-white p-3 rounded-lg shadow-sm">
            <div class="info-label mb-1">Nota clínica</div>
            <div class="text-gray-700 mt-1 p-2 bg-gray-50 rounded border border-gray-100 min-h-[60px]">
              ${c['Nota'] || 'Sin notas clínicas registradas'}
            </div>
          </div>
          <div class="bg-white p-3 rounded-lg shadow-sm">
            <div class="info-label mb-1">Última visita</div>
            <div class="grid grid-cols-2 gap-2 mt-1">
              <div class="flex items-center gap-1 text-gray-700">
                <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M6 2a1 1 0 00-1 1v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2h-1V3a1 1 0 10-2 0v1H7V3a1 1 0 00-1-1zm0 5a1 1 0 000 2h8a1 1 0 100-2H6z" clip-rule="evenodd"></path>
                </svg>
                ${fecha}
              </div>
              <div class="flex items-center gap-1 text-gray-700">
                <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                </svg>
                ${hora}
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
    infoDiv.classList.remove('hidden');
    btnTexto.innerHTML = `
      <span>Ocultar detalles</span>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path>
      </svg>
    `;
  } else {
    infoDiv.classList.add('hidden');
    btnTexto.innerHTML = `
      <span>Ver detalles</span>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    `;
  }
};

  let timeoutId; // Para implementar debounce

function setupSearchAutocomplete() {
  const searchInput = document.getElementById('searchInput');
  const clearSearchBtn = document.getElementById('clearSearchBtn');
  const suggestionsBox = document.getElementById('searchSuggestions');
  
  // Mostrar sugerencias en tiempo real al escribir
  searchInput.addEventListener('input', function() {
    const busqueda = this.value.toLowerCase().trim();
    console.log("Búsqueda: ", busqueda); // Para depuración
    
    // Si se borra el campo, mostrar todos los clientes
    if (!busqueda) {
      suggestionsBox.classList.add('hidden');
      mostrarPagina(1); // Mostrar todos los clientes paginados
      return;
    }
    
    // Filtrar la lista principal con clientes que coinciden con la búsqueda
    filtrarClientesPorLetras(busqueda);
    
    // Actualizar sugerencias
    mostrarSugerencias(busqueda);
  });
  
  // Limpiar búsqueda
  if (clearSearchBtn) {
    clearSearchBtn.addEventListener('click', function() {
      searchInput.value = '';
      suggestionsBox.classList.add('hidden');
      mostrarPagina(1); // Mostrar todos los clientes
    });
  }
  
  // Cerrar sugerencias al hacer clic fuera
  document.addEventListener('click', function(e) {
    if (!searchInput.contains(e.target) && !suggestionsBox.contains(e.target)) {
      suggestionsBox.classList.add('hidden');
    }
  });
  
  // Manejo de teclas para navegación entre sugerencias
  searchInput.addEventListener('keydown', function(e) {
    if (suggestionsBox.classList.contains('hidden')) return;
    
    const items = suggestionsBox.querySelectorAll('.suggestion-item');
    if (!items.length) return;
    
    // Encuentra el ítem actualmente seleccionado
    const currentActive = suggestionsBox.querySelector('.bg-indigo-100');
    let index = -1;
    
    if (currentActive) {
      for (let i = 0; i < items.length; i++) {
        if (items[i] === currentActive) {
          index = i;
          break;
        }
      }
    }
    
    if (e.key === 'ArrowDown') {
      e.preventDefault();
      const nextIndex = (index + 1) % items.length;
      if (currentActive) currentActive.classList.remove('bg-indigo-100');
      items[nextIndex].classList.add('bg-indigo-100');
      items[nextIndex].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'ArrowUp') {
      e.preventDefault();
      const prevIndex = index <= 0 ? items.length - 1 : index - 1;
      if (currentActive) currentActive.classList.remove('bg-indigo-100');
      items[prevIndex].classList.add('bg-indigo-100');
      items[prevIndex].scrollIntoView({ block: 'nearest' });
    } else if (e.key === 'Enter' && currentActive) {
      e.preventDefault();
      currentActive.click();
    } else if (e.key === 'Escape') {
      suggestionsBox.classList.add('hidden');
    }
  });
}

// Función para filtrar clientes mientras se escribe
function filtrarClientesPorLetras(busqueda) {
  console.log("Filtrando por:", busqueda);
  console.log("Total clientes:", clientes.length);
  
  if (!busqueda.trim()) {
    // Si el campo está vacío, mostrar todos los clientes paginados
    mostrarPagina(1);
    return;
  }
  
  if (!clientes || clientes.length === 0) {
    console.error("No hay clientes para filtrar");
    return;
  }

  // Convertir búsqueda a minúscula para comparación insensible a mayúsculas
  busqueda = busqueda.toLowerCase();
  
  // Filtrar clientes que coincidan con la búsqueda (nombre, número o servicio)
  const clientesFiltrados = clientes.filter(cliente => {
    // Convertir explícitamente a string antes de toLowerCase()
    const nombre = String(cliente['Nombre Cliente'] || '').toLowerCase();
    const numero = String(cliente['Numero'] || '').toLowerCase();
    const servicio = String(cliente['Servicio'] || '').toLowerCase();
    
    return nombre.includes(busqueda) || 
           numero.includes(busqueda) ||
           servicio.includes(busqueda);
  });
  
  // Ordenar resultados: primero los que empiezan con la búsqueda
  clientesFiltrados.sort((a, b) => {
    const nombreA = (a['Nombre Cliente'] || '').toLowerCase();
    const nombreB = (b['Nombre Cliente'] || '').toLowerCase();
    
    // Priorizar coincidencias al inicio del nombre
    if (nombreA.startsWith(busqueda) && !nombreB.startsWith(busqueda)) return -1;
    if (!nombreA.startsWith(busqueda) && nombreB.startsWith(busqueda)) return 1;
    
    // Si ambos empiezan o no empiezan, ordenar alfabéticamente
    return nombreA.localeCompare(nombreB);
  });
  
  // Mostrar los resultados
  const container = document.getElementById('clientesCards');
  container.innerHTML = '';
  
  // Actualizar contador
  document.getElementById('totalClientes').textContent = clientesFiltrados.length;
  
  // Ocultar paginación cuando se filtran resultados
  document.getElementById('clientesPagination').innerHTML = '';
  
  // Si no hay resultados, mostrar mensaje amigable
  if (clientesFiltrados.length === 0) {
    container.innerHTML = `
      <div class="col-span-1 sm:col-span-2 lg:col-span-3 p-8 text-center">
        <div class="bg-gray-50 border-l-4 border-gray-300 p-6 rounded-lg">
          <p class="text-gray-700 font-semibold">No se encontraron clientes que contengan "${busqueda}"</p>
          <p class="text-gray-500 mt-2">Intenta con otros términos de búsqueda</p>
        </div>
      </div>
    `;
    return;
  }
  
  // Mostrar los clientes filtrados with escalonada animación
  clientesFiltrados.forEach((c, idx) => {
  // Obtener iniciales para el avatar
  const iniciales = ((c['Nombre Cliente'] || '').match(/\b\w/g) || []).join('').toUpperCase().substring(0, 2);
  
  // Determinar color de estado
  const estadoClase = c['Estado'] && c['Estado'].toLowerCase() === 'activo' 
    ? 'bg-green-100 text-green-800 border-green-200' 
    : 'bg-gray-100 text-gray-700 border-gray-200';
    
  const card = document.createElement('div');
  card.className = "rounded-xl shadow border border-indigo-100 p-5 flex flex-col gap-3 bg-white hover:shadow-2xl hover:-translate-y-1 transition duration-300 animate-fadeIn";
  card.style.animationDelay = `${idx * 50}ms`;
  
  // Resaltar las coincidencias en el nombre
  const nombreCliente = c['Nombre Cliente'] || '';
  const nombreResaltado = resaltarTexto(nombreCliente, busqueda);
  
  card.innerHTML = `
    <div class="flex items-center">
      <div class="cliente-avatar">${iniciales}</div>
      <div>
        <h3 class="font-bold text-indigo-900 text-lg leading-tight">${nombreResaltado}</h3>
        <span class="text-xs font-medium px-2 py-0.5 rounded-full ${estadoClase}">${c['Estado'] || 'Sin estado'}</span>
      </div>
    </div>
    
    <div class="grid grid-cols-2 gap-3 mt-1">
      <div>
        <div class="info-label">Teléfono</div>
        <div class="flex items-center gap-1 text-gray-700">
          <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
            <path d="M2 3a1 1 0 011-1h2.153a1 1 0 01.986.836l.74 4.435a1 1 0 01-.54 1.06l-1.548.773a11.037 11.037 0 006.105 6.105l.774-1.548a1 1 0 011.059-.54l4.435.74a1 1 0 01.836.986V17a1 1 0 01-1 1h-2C7.82 18 2 12.18 2 5V3z"></path>
          </svg>
          ${resaltarTexto(String(c['Numero'] || ''), busqueda)}
        </div>
      </div>
      <div>
        <div class="info-label">Servicio</div>
        <div class="flex items-center gap-1 text-gray-700">
          <svg class="w-4 h-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"></path>
          </svg>
          ${resaltarTexto(String(c['Servicio'] || ''), busqueda)}
        </div>
      </div>
    </div>
    
    <button onclick="mostrarMasInfo('filtrado-${idx}')" class="mt-2 btn-ver-mas bg-indigo-500 text-white px-4 py-2 rounded-md text-sm hover:bg-indigo-600 transition self-end flex items-center gap-1">
      <span>Ver detalles</span>
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
      </svg>
    </button>
    <div id="infoExtra-filtrado-${idx}" class="hidden mt-3 text-sm text-gray-700"></div>
  `;
  container.appendChild(card);
  
  // Almacenar referencia al cliente para "Ver más"
  card.setAttribute('data-cliente', JSON.stringify(c));
});

}

// Modificar la función mostrarMasInfo para soportar los elementos filtrados
window.mostrarMasInfo = function(idxStr) {
  // Determinar si es un índice normal o un filtrado
  const esFiltrado = idxStr.toString().includes('filtrado-');
  const infoDiv = document.getElementById(
    esFiltrado ? 'infoExtra-' + idxStr : 'infoExtra' + idxStr
  );
  
  let cliente;
  
  if (esFiltrado) {
    // Para elementos filtrados, obtener cliente del atributo data
    const cardElement = infoDiv.closest('div[data-cliente]');
    if (!cardElement) return;
    
    cliente = JSON.parse(cardElement.getAttribute('data-cliente'));
  } else {
    // Para elementos normales, obtener del array global
    const idx = parseInt(idxStr);
    cliente = clientes[idx];
  }
  
  if (infoDiv.classList.contains('hidden')) {
    // Formatea fecha y hora si existe
    let fecha = '';
    let hora = '';
    if (cliente['Fecha']) {
      const fechaObj = new Date(cliente['Fecha']);
      fecha = fechaObj.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
      hora = fechaObj.toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit', hour12: true });
    }
    
    infoDiv.innerHTML = `
      <div class="rounded-lg border border-indigo-100 bg-indigo-50 p-3 shadow-inner animate-fadeIn">
        <div class="flex items-center gap-2 mb-1">
          <span class="text-indigo-600">📝</span>
          <span><b>Nota:</b> ${cliente['Nota'] || 'Sin nota'}</span>
        </div>
        <div class="flex items-center gap-2 mb-1">
          <span class="text-indigo-600">🔖</span>
          <span><b>Estado:</b> <span class="px-2 py-0.5 rounded-full text-xs font-semibold ${cliente['Estado'] && cliente['Estado'].toLowerCase() === 'activo' ? 'bg-green-200 text-green-800' : 'bg-gray-200 text-gray-700'}">${cliente['Estado'] || ''}</span></span>
        </div>
        <div class="flex items-center gap-2 mb-1">
          <span class="text-indigo-600">📅</span>
          <span><b>Fecha última cita:</b> ${fecha || ''}</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-indigo-600">⏰</span>
          <span><b>Hora última cita:</b> ${hora || ''}</span>
        </div>
      </div>
    `;
    infoDiv.classList.remove('hidden');
  } else {
    infoDiv.classList.add('hidden');
  }
};

// Reemplazar la función resaltarTexto existente

function resaltarTexto(texto, busqueda) {
  // Asegurarse de que texto sea siempre una cadena
  texto = String(texto || '');
  
  if (!busqueda || !texto) return texto;
  
  try {
    // Escapar caracteres especiales en la búsqueda para usarla en regex
    const busquedaEscapada = busqueda.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    
    // Crear una expresión regular para encontrar la búsqueda (insensible a mayúsculas/minúsculas)
    const regex = new RegExp(`(${busquedaEscapada})`, 'gi');
    
    // Reemplazar las coincidencias con el mismo texto pero envuelto en un span con estilo
    return texto.replace(regex, '<span class="bg-yellow-200 font-semibold">$1</span>');
  } catch (error) {
    console.error("Error al resaltar texto:", error);
    return texto; // Devolver el texto original si hay algún error
  }
}

// Función para mostrar sugerencias en el dropdown
function mostrarSugerencias(busqueda) {
  const suggestionsBox = document.getElementById('searchSuggestions');
  
  // Filtrar clientes que coincidan con la búsqueda
  const sugerencias = clientes.filter(cliente => {
    // Convertir explícitamente a string antes de toLowerCase()
    const nombre = String(cliente['Nombre Cliente'] || '').toLowerCase();
    const numero = String(cliente['Numero'] || '').toLowerCase();
    const servicio = String(cliente['Servicio'] || '').toLowerCase();
    
    return nombre.includes(busqueda) || 
           numero.includes(busqueda) ||
           servicio.includes(busqueda);
  }).slice(0, 6); // Limitar a 6 sugerencias para no sobrecargar la UI
  
  // Ordenar sugerencias: primero los que empiezan con la búsqueda
  sugerencias.sort((a, b) => {
    const nombreA = (a['Nombre Cliente'] || '').toLowerCase();
    const nombreB = (b['Nombre Cliente'] || '').toLowerCase();
    
    if (nombreA.startsWith(busqueda) && !nombreB.startsWith(busqueda)) return -1;
    if (!nombreA.startsWith(busqueda) && nombreB.startsWith(busqueda)) return 1;
    
    return nombreA.localeCompare(nombreB);
  });
  
  // Si no hay sugerencias, ocultar el cuadro
  if (sugerencias.length === 0) {
    suggestionsBox.classList.add('hidden');
    return;
  }
  
  // Mostrar sugerencias
  suggestionsBox.innerHTML = '';
  sugerencias.forEach(cliente => {
    const item = document.createElement('div');
    item.className = 'suggestion-item px-4 py-2 hover:bg-indigo-50 cursor-pointer border-b last:border-b-0 border-indigo-100';
    
    // Resaltar texto coincidente
    const nombreResaltado = resaltarTexto(cliente['Nombre Cliente'] || '', busqueda);
    const numeroResaltado = resaltarTexto(cliente['Numero'] || '', busqueda);
    
    item.innerHTML = `
      <div class="font-semibold">${nombreResaltado}</div>
      <div class="text-xs text-gray-500">${numeroResaltado}</div>
    `;
    
    // Al hacer clic en una sugerencia, rellenar el input y filtrar
    item.addEventListener('click', () => {
      document.getElementById('searchInput').value = cliente['Nombre Cliente'] || '';
      filtrarClientesPorLetras(cliente['Nombre Cliente'].toLowerCase());
      suggestionsBox.classList.add('hidden');
    });
    
    suggestionsBox.appendChild(item);
  });
  
  // Mostrar el cuadro de sugerencias
  suggestionsBox.classList.remove('hidden');
}

// Inicializar cartera de clientes y configurar búsqueda
document.addEventListener('DOMContentLoaded', function() {
  cargarClientes();
  setupSearchAutocomplete();
  
  // Escuchar evento clic en botón nuevo cliente
  document.getElementById('addClientBtn').addEventListener('click', function() {
    alert('Funcionalidad de nuevo cliente no implementada');
  });
  
  // Manejar evento sidebar móvil
  if (document.getElementById('closeSidebarMobile')) {
    document.getElementById('closeSidebarMobile').addEventListener('click', function() {
      document.getElementById('sidebarMobile').classList.add('-translate-x-full');
      document.getElementById('sidebarMobileBackdrop').classList.add('hidden');
    });
  }
  
  if (document.getElementById('sidebarToggle')) {
    document.getElementById('sidebarToggle').addEventListener('click', function() {
      document.getElementById('sidebarMobile').classList.remove('-translate-x-full');
      document.getElementById('sidebarMobileBackdrop').classList.remove('hidden');
    });
  }
});
</script>

<!-- Tailwind extra styles -->
<style>
  /* Mejora del header con efecto de vidrio más pronunciado */
header {
  background: rgba(255, 255, 255, 0.8);
  backdrop-filter: blur(12px);
  border-bottom: 1px solid rgba(219, 234, 254, 0.7);
  box-shadow: 0 4px 20px rgba(99, 102, 241, 0.08);
  transition: all 0.3s ease;
  padding: 1rem 1.5rem;
}

/* Mejora del título principal */
header h1 {
  background: linear-gradient(135deg, #4f46e5, #818cf8);
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  font-weight: 800;
  letter-spacing: -0.02em;
  text-shadow: 1px 1px 2px rgba(79, 70, 229, 0.1);
}

/* Mejora del fondo de la página */
body {
  background-image: 
    radial-gradient(circle at 20% 20%, rgba(224, 231, 255, 0.8) 0%, transparent 25%),
    radial-gradient(circle at 80% 80%, rgba(199, 210, 254, 0.8) 0%, transparent 25%),
    linear-gradient(135deg, #f9fafb 0%, #f5f7ff 100%);
  background-attachment: fixed;
}

/* Mejora de la sección principal */
main section {
  border-radius: 1rem;
  box-shadow: 0 10px 30px rgba(99, 102, 241, 0.08), 0 1px 5px rgba(99, 102, 241, 0.05);
  border: 1px solid rgba(219, 234, 254, 0.7);
  background: linear-gradient(to bottom right, rgba(255, 255, 255, 0.95), rgba(249, 250, 251, 0.95));
  backdrop-filter: blur(8px);
  transition: all 0.3s ease;
}

/* Añadir animación de hover a la sección principal */
main section:hover {
  box-shadow: 0 14px 35px rgba(99, 102, 241, 0.12), 0 3px 10px rgba(99, 102, 241, 0.07);
  transform: translateY(-3px);
}

/* Diseño mejorado de tarjetas de clientes */
#clientesCards .rounded-xl {
  background: linear-gradient(145deg, #ffffff, #f9faff);
  box-shadow: 0 6px 18px rgba(67, 56, 202, 0.06);
  border: 1px solid rgba(99, 102, 241, 0.12);
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  position: relative;
  overflow: hidden;
}

/* Efecto hover mejorado */
#clientesCards .rounded-xl:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 12px 28px rgba(67, 56, 202, 0.15);
  border-color: rgba(99, 102, 241, 0.3);
  z-index: 1;
}

/* Añadir línea decorativa superior a las tarjetas */
#clientesCards .rounded-xl:before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #6366f1, #818cf8);
  border-radius: 4px 4px 0 0;
}

/* Avatar mejorado */
.cliente-avatar {
  width: 45px;
  height: 45px;
  background: linear-gradient(135deg, #4f46e5, #818cf8);
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 700;
  font-size: 1.2rem;
  margin-right: 12px;
  box-shadow: 0 3px 10px rgba(99, 102, 241, 0.3);
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease;
}

/* Efecto hover en avatar */
.cliente-avatar:hover {
  transform: rotate(5deg) scale(1.05);
}

/* Mejora de la información adicional */
.info-extra-container {
  background: linear-gradient(to bottom, #eef2ff, #e0e7ff);
  border-radius: 12px;
  box-shadow: inset 0 2px 8px rgba(0,0,0,0.06);
  animation: slideDown 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
  border: 1px solid rgba(99, 102, 241, 0.15);
}

/* Botón ver detalles mejorado */
.btn-ver-mas {
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  border-radius: 8px;
  box-shadow: 0 3px 8px rgba(99, 102, 241, 0.3);
  font-weight: 600;
  letter-spacing: 0.01em;
  padding: 0.5rem 1rem;
  transform-origin: right bottom;
  transition: all 0.3s ease;
}

.btn-ver-mas:hover {
  background: linear-gradient(135deg, #4338ca, #4f46e5);
  transform: translateY(-2px) scale(1.03);
  box-shadow: 0 5px 12px rgba(99, 102, 241, 0.4);
}

/* Iconos con animación */
.btn-ver-mas svg, .info-label + div svg {
  transition: transform 0.3s ease;
}

.btn-ver-mas:hover svg {
  transform: translateY(2px);
}

.info-label + div:hover svg {
  transform: scale(1.2);
}

/* Paginación más atractiva */
#clientesPagination {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 2rem;
  padding: 0.75rem;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(8px);
  border-radius: 1rem;
  box-shadow: 0 4px 15px rgba(99, 102, 241, 0.1);
  border: 1px solid rgba(219, 234, 254, 0.7);
  width: fit-content;
  margin-left: auto;
  margin-right: auto;
}

#clientesPagination button {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  margin: 0 0.25rem;
  border-radius: 0.5rem;
  font-weight: 600;
  transition: all 0.3s ease;
}

#clientesPagination button.bg-indigo-600 {
  transform: translateY(-2px);
  box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
}

#clientesPagination button:not(.bg-indigo-600):not(.text-gray-400):hover {
  background-color: rgba(99, 102, 241, 0.1);
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(99, 102, 241, 0.2);
}

/* Animaciones para la paginación */
@keyframes pulse-dot {
  0% { transform: scale(0.95); }
  50% { transform: scale(1.1); }
  100% { transform: scale(0.95); }
}

.total-pulse {
  animation: pulse-dot 2s cubic-bezier(0.455, 0.03, 0.515, 0.955) infinite;
}
</style>
</body>
</html>
